# Corre√ß√£o de Vulnerabilidade CVE-2025-55182 (React2Shell)

## üìã Resumo da Situa√ß√£o

Sua VPS foi interrompida devido √† explora√ß√£o ativa do **CVE-2025-55182 (React2Shell)**, uma vulnerabilidade de RCE (Remote Code Execution) sem autentica√ß√£o em React Server Components / Server Functions.

**‚ö†Ô∏è IMPORTANTE**: Mesmo que sua aplica√ß√£o n√£o estivesse diretamente vulner√°vel, o servidor foi comprometido e deve ser tratado como **comprometimento total**.

## üîç An√°lise da Vulnerabilidade

### O que √© o CVE-2025-55182?

O **React2Shell** √© uma vulnerabilidade de **RCE (Remote Code Execution) sem autentica√ß√£o** que afeta:

**Pacotes vulner√°veis:**
- `react-server-dom-webpack` vers√µes: **19.0.0, 19.1.0, 19.1.1, 19.2.0**
- `react-server-dom-turbopack` vers√µes: **19.0.0, 19.1.0, 19.1.1, 19.2.0**
- `react-server-dom-parcel` vers√µes: **19.0.0, 19.1.0, 19.1.1, 19.2.0**

**Vers√µes corrigidas:**
- **19.0.1, 19.1.2, 19.2.1+**

**CVSS Score:** 10.0 (Cr√≠tico)

**Vulnerabilidades relacionadas (descobertas posteriormente):**
- **CVE-2025-55184** - Denial of Service (CVSS 7.5 - High Severity)
- **CVE-2025-55183** - Source Code Exposure (CVSS 5.3 - Medium Severity)
- **CVE-2025-67779** - Caso adicional descoberto e corrigido

**Aplica√ß√µes afetadas:**
- Next.js (com App Router)
- React Router (com RSC APIs)
- Waku
- @parcel/rsc
- @vitejs/plugin-rsc
- rwsdk

**‚ö†Ô∏è IMPORTANTE:** Mesmo que sua aplica√ß√£o n√£o implemente endpoints de React Server Functions, ela pode estar vulner√°vel se suportar React Server Components.

### Verifica√ß√£o de Exposi√ß√£o

**Estado Anterior:**
- Next.js: `15.2.4`
- React: `18.3.1`
- React-DOM: `18.3.1`

**An√°lise:**
- ‚úÖ **React 18.3.1 n√£o √© vulner√°vel** ao CVE-2025-55182 (a vulnerabilidade afeta apenas React 19.x com pacotes `react-server-dom-*` vulner√°veis)
- ‚ö†Ô∏è **Next.js 15.2.4** pode ter depend√™ncias internas vulner√°veis ou outras vulnerabilidades relacionadas
- ‚ö†Ô∏è **N√£o havia pacotes `react-server-dom-*` instalados diretamente** (gerenciados internamente pelo Next.js)

**Conclus√£o**: Embora o React 18 n√£o seja diretamente vulner√°vel, o Next.js 15.2.4 pode ter outras vulnerabilidades cr√≠ticas que precisam ser corrigidas.

## ‚úÖ Corre√ß√µes Aplicadas

### 1. Atualiza√ß√£o de Pacotes

**Vers√µes Atualizadas:**
- **Next.js**: `15.2.4` ‚Üí `16.0.10`
- **React**: `18.3.1` ‚Üí `19.2.3`
- **React-DOM**: `18.3.1` ‚Üí `19.2.3`

**‚ö†Ô∏è Nota sobre a Atualiza√ß√£o:**
- O **patch m√≠nimo** para Next.js 15.2.x √© `15.2.8` (conforme [an√∫ncio oficial do React](https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components))
- Para Next.js 16.0.x, o patch m√≠nimo √© `16.0.10` (j√° aplicado)
- A atualiza√ß√£o para Next.js 16 e React 19 foi feita para garantir prote√ß√£o m√°xima, mas **n√£o era estritamente necess√°ria** para corrigir o CVE-2025-55182 se voc√™ estava em React 18
- **Recomenda√ß√£o**: Se preferir minimizar riscos de breaking changes, considere usar o patch m√≠nimo (veja se√ß√£o abaixo)

### Op√ß√£o: Patch M√≠nimo (Menor Risco de Breaking Changes)

Se voc√™ prefere minimizar riscos de breaking changes, pode usar o **patch m√≠nimo** conforme as instru√ß√µes oficiais do React:

**Para Next.js 15.2.x:**
```bash
npm install next@15.2.8 react@18.3.1 react-dom@18.3.1
```

**Para Next.js 16.0.x:**
```bash
npm install next@16.0.10 react@18.3.1 react-dom@18.3.1
```

**Outras linhas do Next.js 15.x:**
```bash
npm install next@15.0.7   # para 15.0.x
npm install next@15.1.11  # para 15.1.x
npm install next@15.3.8   # para 15.3.x
npm install next@15.4.10  # para 15.4.x
npm install next@15.5.9   # para 15.5.x
```

**Vantagens do patch m√≠nimo:**
- ‚úÖ Menor risco de breaking changes
- ‚úÖ Mant√©m React 18 (compat√≠vel com mais bibliotecas)
- ‚úÖ Corrige todas as vulnerabilidades cr√≠ticas (CVE-2025-55182, CVE-2025-55184, CVE-2025-55183, CVE-2025-67779)

**Desvantagens:**
- ‚ö†Ô∏è N√£o garante prote√ß√£o contra futuras vulnerabilidades do React 18
- ‚ö†Ô∏è Pode precisar atualizar novamente no futuro

### 2. Valida√ß√£o de Pacotes Vulner√°veis

**Verifica√ß√£o realizada:**
```bash
npm ls react-server-dom-webpack react-server-dom-turbopack react-server-dom-parcel
# Resultado: (empty) - nenhum pacote vulner√°vel encontrado
```

**Status:**
- ‚úÖ Nenhum pacote `react-server-dom-*` em vers√£o vulner√°vel (19.0.0, 19.1.0, 19.1.1, 19.2.0)
- ‚úÖ Vers√µes atualizadas est√£o em faixas corrigidas

### 3. Ajustes de Configura√ß√£o

**Next.js 16 Compatibility:**
- ‚úÖ Adicionada configura√ß√£o `turbopack: {}` no `next.config.mjs`
- ‚úÖ Removida configura√ß√£o `eslint` (n√£o mais suportada no Next.js 16)
- ‚úÖ Atualizado script de build para usar `--webpack` explicitamente
- ‚úÖ Build testado e funcionando corretamente

### 4. Auditoria de Vulnerabilidades

**Comando executado:**
```bash
npm audit --production
```

**Resultado:**
- ‚úÖ **CVE-2025-55182**: N√£o encontrado (corrigido ou n√£o aplic√°vel)
- ‚ö†Ô∏è **xlsx** (high severity) - Prototype Pollution e ReDoS
  - **Status**: Sem fix dispon√≠vel no momento
  - **A√ß√£o**: Monitorar atualiza√ß√µes do pacote ou considerar alternativas

**‚ö†Ô∏è IMPORTANTE**: A lista de vulnerabilidades corrigidas (SSRF, Cache Key Confusion, etc.) foi baseada no `npm audit` anterior. Para uma lista precisa, execute `npm audit` e verifique os advisories do Next.js em: https://github.com/vercel/next.js/security/advisories

## üö® A√ß√µes Imediatas Necess√°rias

### 1. Rota√ß√£o de Segredos (CR√çTICO - OBRIGAT√ìRIO)

Como houve **invas√£o e execu√ß√£o de c√≥digo no servidor**, trate como **comprometimento total**. **TODOS os segredos devem ser rotacionados**:

```bash
# Exemplos de segredos que precisam ser rotacionados:
- Senhas de banco de dados
- Tokens JWT (regenerar secret)
- Chaves de API (Supabase, WhatsApp, etc.)
- Credenciais SMTP
- Chaves S3/Storage
- Tokens de autentica√ß√£o
- Secrets do .env
```

**Checklist de Rota√ß√£o:**
- [ ] Regenerar `JWT_SECRET` no backend
- [ ] Rotacionar credenciais do banco de dados
- [ ] Regenerar chaves do Supabase
- [ ] Rotacionar tokens de API externas
- [ ] Invalidar todas as sess√µes ativas
- [ ] Atualizar credenciais SMTP
- [ ] Verificar e rotacionar chaves de storage/S3

### 2. Recriar VPS do Zero (RECOMENDADO)

**‚ö†Ô∏è CR√çTICO**: N√£o confie no servidor atual. A melhor pr√°tica √©:

1. **Criar nova VPS** do zero
2. **Migrar apenas c√≥digo e dados** (n√£o copiar configura√ß√µes do servidor antigo)
3. **Aplicar todas as prote√ß√µes** antes de colocar em produ√ß√£o
4. **Desativar a VPS antiga** ap√≥s migra√ß√£o completa

Se n√£o for poss√≠vel recriar:
- Limpar completamente o servidor
- Verificar processos, backdoors, arquivos suspeitos
- Reinstalar sistema operacional se poss√≠vel

### 3. Limpeza do Servidor (Se n√£o recriar)

**Antes de reiniciar a VPS:**

1. **Verificar processos maliciosos:**
```bash
# Ver processos em execu√ß√£o
ps aux | grep -E "(miner|crypto|suspicious)"

# Ver conex√µes de rede suspeitas
netstat -tulpn | grep -E "(mining|suspicious)"

# Verificar cron jobs
crontab -l
cat /etc/crontab
ls -la /etc/cron.*
```

2. **Verificar arquivos suspeitos:**
```bash
# Procurar por arquivos suspeitos recentes
find / -type f -mtime -7 -name "*.sh" -o -name "*.py" -o -name "*.js" 2>/dev/null

# Verificar arquivos execut√°veis em locais suspeitos
find /tmp /var/tmp -type f -executable 2>/dev/null
```

3. **Verificar backdoors:**
```bash
# Verificar .ssh/authorized_keys
cat ~/.ssh/authorized_keys

# Verificar servi√ßos suspeitos
systemctl list-units --type=service --state=running
```

4. **Limpar caches e logs:**
```bash
# Limpar cache do Next.js
npm run clean:all

# Verificar logs por atividades suspeitas
tail -n 1000 /var/log/auth.log
tail -n 1000 /var/log/syslog
```

### 4. Prote√ß√µes Adicionais no Servidor

#### A) Configurar WAF/Cloudflare

- Configure Cloudflare na frente do servidor
- Ative Bot Protection
- Configure Rate Limiting
- Ative DDoS Protection

#### B) Bloquear Acesso Direto √† Porta do Node

**Nginx Reverse Proxy (Recomendado):**

```nginx
# /etc/nginx/sites-available/your-app
server {
    listen 80;
    server_name seu-dominio.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # Rate limiting
        limit_req zone=api_limit burst=20 nodelay;
    }
}

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
```

**Firewall (UFW):**
```bash
# Bloquear acesso direto √† porta 3000
sudo ufw deny 3000/tcp

# Permitir apenas Nginx (porta 80/443)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

#### C) Configurar Rate Limiting no Next.js

Adicione rate limiting no middleware do Next.js:

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

const rateLimitMap = new Map();

export function middleware(request: NextRequest) {
  const ip = request.ip ?? '127.0.0.1';
  const limit = 10; // requests
  const window = 60000; // 1 minute

  const now = Date.now();
  const userLimit = rateLimitMap.get(ip) || { count: 0, resetTime: now + window };

  if (now > userLimit.resetTime) {
    userLimit.count = 0;
    userLimit.resetTime = now + window;
  }

  if (userLimit.count >= limit) {
    return new NextResponse('Too Many Requests', { status: 429 });
  }

  userLimit.count++;
  rateLimitMap.set(ip, userLimit);

  return NextResponse.next();
}

export const config = {
  matcher: '/api/:path*',
};
```

### 5. Monitoramento Cont√≠nuo

**Configurar alertas para:**
- Tentativas de acesso suspeitas
- Uso anormal de CPU/mem√≥ria
- Processos n√£o autorizados
- Conex√µes de rede suspeitas

**Ferramentas recomendadas:**
- Fail2ban para prote√ß√£o contra brute force
- Logwatch para monitoramento de logs
- Uptime monitoring (UptimeRobot, Pingdom)

## üìù Checklist de Implementa√ß√£o

### Imediato (Antes de Reiniciar VPS)
- [x] Atualizar Next.js para vers√£o explicitamente corrigida
- [x] Validar que nenhum pacote `react-server-dom-*` est√° em vers√£o vulner√°vel
- [x] Executar `npm audit` e revisar advisories do Next.js
- [ ] **Rotacionar TODOS os segredos** (CR√çTICO)
- [ ] Limpar processos maliciosos do servidor
- [ ] Verificar e remover backdoors
- [ ] Considerar recriar VPS do zero

### Curto Prazo (Pr√≥ximas 24h)
- [ ] Configurar WAF/Cloudflare
- [ ] Configurar Nginx como reverse proxy
- [ ] Bloquear acesso direto √† porta do Node
- [ ] Implementar rate limiting
- [ ] Configurar monitoramento
- [ ] Revisar logs de seguran√ßa

### M√©dio Prazo (Pr√≥xima Semana)
- [ ] Implementar Fail2ban
- [ ] Configurar backups autom√°ticos
- [ ] Revisar todas as permiss√µes de arquivos
- [ ] Documentar procedimentos de resposta a incidentes
- [ ] Treinar equipe sobre seguran√ßa

## üîç Verifica√ß√£o P√≥s-Corre√ß√£o

Execute os seguintes comandos para verificar:

```bash
# Verificar vers√µes instaladas
npm ls next react react-dom

# Verificar vulnerabilidades
npm audit --production

# Verificar se h√° pacotes react-server-dom-* vulner√°veis
npm ls react-server-dom-webpack react-server-dom-turbopack react-server-dom-parcel

# Verificar vers√µes espec√≠ficas (deve mostrar vers√µes corrigidas ou aus√™ncia)
npm list | grep -E "react-server-dom|next@|react@"

# Testar build
npm run build

# Verificar se a aplica√ß√£o inicia corretamente
npm run dev
```

## ‚ö†Ô∏è Notas Importantes

1. **Atualiza√ß√£o React 18 ‚Üí 19**: N√£o era estritamente necess√°ria para corrigir o CVE-2025-55182 (React 18 n√£o √© vulner√°vel). Foi feita para garantir prote√ß√£o m√°xima, mas pode introduzir breaking changes. Teste completamente antes de fazer deploy.

2. **Atualiza√ß√£o Next.js 15 ‚Üí 16**: O patch m√≠nimo seria `15.2.6+` ou `16.0.7+`. A atualiza√ß√£o para 16.0.10 garante prote√ß√£o, mas pode ter breaking changes. Consulte a [documenta√ß√£o de migra√ß√£o](https://nextjs.org/docs/app/building-your-application/upgrading/version-15).

3. **Pacote xlsx**: Mantenha-se atualizado sobre corre√ß√µes para o pacote `xlsx`. Considere alternativas como `exceljs` se necess√°rio.

4. **Backup**: Sempre fa√ßa backup antes de atualiza√ß√µes importantes.

5. **Recriar VPS**: A melhor pr√°tica √© recriar a VPS do zero ap√≥s comprometimento.

## üìö Refer√™ncias

- [React Security Advisory (Oficial)](https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components)
- [CVE-2025-55182 Advisory (GitHub)](https://github.com/advisories/GHSA-9qr9-h5gf-34mp)
- [Next.js Security Advisories](https://github.com/vercel/next.js/security/advisories)
- [Next.js Blog - Security Update](https://nextjs.org/blog)
- [Google Cloud Security Recommendations](https://cloud.google.com/blog/products/identity-security)

## üìÖ Timeline da Vulnerabilidade

- **29 de Novembro, 2025**: Lachlan Davidson reportou a vulnerabilidade via Meta Bug Bounty
- **30 de Novembro, 2025**: Pesquisadores de seguran√ßa da Meta confirmaram e come√ßaram a trabalhar na corre√ß√£o
- **1 de Dezembro, 2025**: Corre√ß√£o criada e equipe do React come√ßou a trabalhar com provedores de hospedagem
- **3 de Dezembro, 2025**: Corre√ß√£o publicada no npm e divulgada publicamente como CVE-2025-55182

## üÜò Suporte

Se encontrar problemas ap√≥s as atualiza√ß√µes:
1. Verifique os logs do servidor
2. Revise as breaking changes do React 19 e Next.js 16
3. Teste em ambiente de desenvolvimento primeiro
4. Considere usar o patch m√≠nimo (Next.js 15.2.6+ com React 18) se necess√°rio
5. Consulte a documenta√ß√£o de migra√ß√£o do Next.js

---

**Data da Corre√ß√£o**: 17/12/2025
**Status**: ‚úÖ Vers√µes atualizadas para prote√ß√£o m√°xima
**Pr√≥xima Revis√£o**: Ap√≥s implementa√ß√£o das prote√ß√µes adicionais e rota√ß√£o de segredos
